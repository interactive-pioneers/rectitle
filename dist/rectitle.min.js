"use strict";function RecTitle(a){return this._hasCapabilities()?this._init(a):null}RecTitle.prototype._hasCapabilities=function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))},RecTitle.prototype._setDefaults=function(){this.defaults={fontFamily:"Helvetica",fontSize:48,fontColor:"#fff",mask:!1,backgroundColor:"#000",backgroundPadding:{left:10,top:0,right:10,bottom:0},backgroundOpacity:1,horizontalSkew:0,opacity:1,className:"rectitle",id:null},this.view=null,this._target=null,this._style=null,this._text=null,this._transformMatrix=null,this._dimensions={width:null,height:null}},RecTitle.prototype._init=function(a){return this._setDefaults(),this.options=this._merge(this._parse(a),this.defaults),this._transformMatrix={m11:1,m12:this.options.horizontalSkew,m21:0,m22:1,dx:0,dy:0},this._initView(),this},RecTitle.prototype._initView=function(){this.view=document.createElement("canvas"),this.view.setAttribute("class",this.options.className),this.view.setAttribute("style","background-color:transparent;"),this.options.id&&this.view.setAttribute("id",this.options.id)},RecTitle.prototype.hasTransformMatrix=function(){return this._transformMatrix&&(0!==this._transformMatrix.m12||0!==this._transformMatrix.m21)},RecTitle.prototype.render=function(a,b){if(!this._hasCapabilities())return!1;if(a)this.setTarget(a);else if(!this.getTarget())throw new Error("Render expects target!");return this._dimensions=this._calculateDimensions(),this.view.setAttribute("width",this._dimensions.width),this.view.setAttribute("height",this._dimensions.height),this._draw()?b?this.view:this.emptyTarget().appendChild(this.view):!1},RecTitle.prototype.emptyTarget=function(){for(var a=this.getTarget();a.firstChild;)a.removeChild(a.firstChild);return a},RecTitle.prototype._calculateDimensions=function(){var a=this.getTextWidth(this.getText()),b=a+this.options.backgroundPadding.left+this.options.backgroundPadding.right,c=this._getRealTextHeight(this.getText(),this.options.fontSize,this.options.fontFamily,a,this.options.fontSize),d=c+this.options.backgroundPadding.top+this.options.backgroundPadding.bottom;return this._getTransformedDimensions(b,d)},RecTitle.prototype._getRealTextHeight=function(a,b,c,d,e){var f=document.createElement("canvas");f.setAttribute("width",d),f.setAttribute("height",e);var g=f.getContext("2d");g.translate(0,Math.round(.8*e)),g.font=b+"px "+c,g.fillStyle="#000",g.fillText(a,0,0);for(var h=g.getImageData(0,0,d,e).data,i=!1,j=!1,k=0,l=e;!j&&l;)for(l--,k=0;d>k;k++)if(h[l*d*4+4*k+3]){j=l;break}for(l=e;l;){for(l--,k=0;d>k;k++)if(h[l*d*4+4*k+3]){i=l;break}if(i!==l)return j-i}return 0},RecTitle.prototype._getTransformedDimensions=function(a,b){var c={width:a,height:b,original:{width:a,height:b},shift:{x:0,y:0}};if(this.hasTransformMatrix()&&0!==this._transformMatrix.m12){var d=Math.atan(this._transformMatrix.m12);c.height=Math.abs(Math.tan(d)*a)+b,c.shift.y=c.height-c.original.height}return c},RecTitle.prototype._draw=function(){var a=this.view.getContext("2d");return this.options.horizontalSkew>0&&a.translate(0,-this._dimensions.shift.y),this.options.opacity<1&&(a.globalAlpha=this.options.opacity),a.font=this.options.fontSize+"px "+this.options.fontFamily,this.hasTransformMatrix()&&a.transform(this._transformMatrix.m11,this._transformMatrix.m12,this._transformMatrix.m21,this._transformMatrix.m22,this._transformMatrix.dx,this._transformMatrix.dy),a.fillStyle=this.getRGBA(this.options.backgroundColor,this.options.backgroundOpacity),a.fillRect(this._dimensions.shift.x,this._dimensions.shift.y,this._dimensions.width-this._dimensions.shift.x,this._dimensions.height-this._dimensions.shift.y),this.options.mask===!0?a.globalCompositeOperation="destination-out":a.fillStyle=this.options.fontColor,a.fillText(this.getText(),this.options.backgroundPadding.left+this._dimensions.shift.x,this._dimensions.original.height-this.options.backgroundPadding.bottom+this._dimensions.shift.y),a},RecTitle.prototype.getRGBA=function(a,b){if(b||(b=1),"#"===a.charAt(0)){if(4===a.length){var c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;a=a.replace(c,function(a,b,c,d){return b+b+c+c+d+d})}var d=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);if(d){var e={r:parseInt(d[1],16),g:parseInt(d[2],16),b:parseInt(d[3],16)};a="rgba("+e.r+","+e.g+","+e.b+","+b+")"}}else 0===a.indexOf("rgb(")&&(a="rgba"+a.substring(3,a.indexOf(")"))+","+b+")");return a},RecTitle.prototype.getTextWidth=function(a){var b=document.createElement("canvas"),c=3072,d=this.options.fontSize+10;b.setAttribute("width",c),b.setAttribute("height",d);var e=b.getContext("2d");return e.font=this.options.fontSize+"px "+this.options.fontFamily,e.textAlign="center",e.fillStyle="black",e.fillText(a,.5*c,.5*d),e.measureText(a).width},RecTitle.prototype.getWidth=function(){return this._dimensions.width},RecTitle.prototype.getHeight=function(){return this._dimensions.height},RecTitle.prototype.getShift=function(){return this._dimensions.shift},RecTitle.prototype.setText=function(a){if(!("string"==typeof a&&a.length>0))throw new TypeError("Invalid text object, non-zero string expected!");var b=this._style.getPropertyValue("text-transform");switch(b){case"uppercase":a=a.toUpperCase();break;case"lowercase":a=a.toLowerCase();break;case"capitalize":a=a.charAt(0).toUpperCase()+a.slice(1)}return this._text=a,this._text},RecTitle.prototype.getText=function(){if(this._text)return this._text;var a=this.getTarget().textContent;return this.setText(a)},RecTitle.prototype.setTarget=function(a){if(!a||!a.tagName)throw new TypeError("HTMLElement expected for target!");return this._target=a,this._style=window.getComputedStyle(this._target),this._target},RecTitle.prototype.getTarget=function(){return this._target},RecTitle.prototype._merge=function(a,b){for(var c in b)void 0!==a[c]&&(b[c]=a[c]);return b},RecTitle.prototype._parse=function(a){if(a.fontSize&&"number"!=typeof a.fontSize)if(Number(a.fontSize).toString()===a.fontSize)a.fontSize=Number(a.fontSize);else{if(!this._isPixelValue(a.fontSize))throw new TypeError("Incorrect font size! Please provide numeric value.");a.fontSize=Number(a.fontSize.substring(0,a.fontSize.indexOf("p")))}if(a.backgroundPadding)for(var b in a.backgroundPadding)a.backgroundPadding[b]=Number(a.backgroundPadding[b]);return a["class"]&&(a.className=a["class"]),a.mask=a.mask&&(a.mask===!0||"true"===a.mask||"1"===a.mask),a},RecTitle.prototype._isPixelValue=function(a){return"number"!=typeof a&&(-1!==a.indexOf("px")||-1!==a.indexOf("pt"))};